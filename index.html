<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRF Synthesizer & Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            transition: background-color 0.3s, transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .upload-box {
            border: 2px dashed #d1d5db;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s, background-color 0.3s;
            position: relative;
        }
        .upload-box:hover, .upload-box.drag-over {
            border-color: #4f46e5;
            background-color: #f0f2ff;
        }
        .upload-box.filled {
             border-color: #10b981;
             background-color: #f0fdf4;
        }
        .clear-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 1.75rem;
            height: 1.75rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            font-size: 1.25rem;
        }
        .clear-btn:hover {
            background-color: #dc2626;
        }
        .expand-btn {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 50%;
            width: 1.75rem;
            height: 1.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }
        .expand-btn:hover {
            opacity: 1;
        }
        .review-box-container {
            position: relative;
        }
        .review-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            height: 450px;
            transition: all 0.5s ease-in-out;
        }
        .review-grid.focused .review-box-container {
            flex-grow: 0;
            width: 50px; /* Shrink width */
        }
        .review-grid.focused .review-box-container.is-focused {
            flex-grow: 1;
            width: auto; /* Expand width */
        }
        .review-grid.focused {
            display: flex;
        }

        .screen {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .hidden {
            display: none;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #fff;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .chat-message {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }
        .user-message {
            background-color: #4f46e5;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4 md:p-8">

    <div id="app" class="w-full max-w-7xl mx-auto">
        
        <!-- Start Screen -->
        <div id="start-screen" class="screen text-center max-w-2xl mx-auto">
             <div class="card p-8 md:p-12">
                <h1 class="text-4xl font-bold">Personal Reality Framework (PRF) Synthesizer</h1>
                <p class="text-gray-600 mt-4 mb-8">The central hub for analyzing and integrating your personal insights.</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="start-here-btn" class="btn btn-primary px-8 py-3 rounded-lg font-semibold text-lg">Start Here</button>
                    <a href="https://rmertzman-tech.github.io/Nelson-Mandela/" target="_blank" class="btn btn-secondary px-8 py-3 rounded-lg font-semibold text-lg">View an Example</a>
                </div>
            </div>
        </div>

        <!-- Explanation Screen -->
        <div id="explanation-screen" class="screen hidden text-left max-w-3xl mx-auto">
            <div class="card p-8 md:p-12">
                <h2 class="text-3xl font-bold text-center mb-6">Synthesize Your Framework</h2>
                <p class="text-gray-700 mb-4">Welcome to the Synthesizer. This is where you bring together the insights you've gathered from all six explorer modules.</p>
                <div class="bg-indigo-50 border-l-4 border-indigo-500 text-indigo-800 p-4 rounded-md my-6">
                    <h3 class="font-bold">How to Use This Tool:</h3>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Use the **"Load Data from Explorers"** button for a quick way to import your saved work.</li>
                        <li>Alternatively, you can **drag-and-drop your .txt files** from each explorer into the upload boxes.</li>
                        <li>The review boxes are editable. You can use the **expand icon** (⤢) for a focused view of your data.</li>
                        <li>Use the **"Begin Guided Synthesis"** feature to have a step-by-step conversation with the AI Tutor to help you synthesize your framework.</li>
                        <li>**Download your complete PRF** as a single file to save your work.</li>
                    </ul>
                </div>
                <div class="text-center">
                    <button id="continue-to-app-btn" class="btn btn-primary px-8 py-3 rounded-lg font-semibold text-lg">Continue to Synthesizer</button>
                </div>
            </div>
        </div>

        <!-- Main App Workspace -->
        <div id="main-app" class="hidden">
            <div class="text-left mb-6">
                 <button id="back-to-start-btn" class="font-semibold text-indigo-600 hover:text-indigo-800">← Back to Start</button>
            </div>
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold">Personal Reality Framework (PRF) Synthesizer</h1>
                <p class="text-gray-600 mt-2">Import your saved summaries from the explorers to begin.</p>
            </div>

            <!-- Main Workspace -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <!-- Left Column: File Uploads -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="card p-6">
                        <h2 class="text-xl font-bold mb-4">1. Import Your Data</h2>
                        <button id="load-data-btn" class="btn btn-primary w-full py-3 mb-4 rounded-lg font-semibold">Load Data from Explorers</button>
                        <p class="text-center text-gray-500 text-sm mb-4">Or upload files manually below</p>
                        <div class="space-y-4">
                            <div id="beliefs-upload-box" class="upload-box"><button id="beliefs-clear-btn" class="clear-btn hidden">&times;</button><p class="font-semibold text-gray-700">Beliefs</p><input type="file" id="beliefs-file-input" class="hidden" accept=".txt"></div>
                            <div id="rules-upload-box" class="upload-box"><button id="rules-clear-btn" class="clear-btn hidden">&times;</button><p class="font-semibold text-gray-700">Rules</p><input type="file" id="rules-file-input" class="hidden" accept=".txt"></div>
                            <div id="ontology-upload-box" class="upload-box"><button id="ontology-clear-btn" class="clear-btn hidden">&times;</button><p class="font-semibold text-gray-700">Ontology</p><input type="file" id="ontology-file-input" class="hidden" accept=".txt"></div>
                            <div id="authenticity-upload-box" class="upload-box"><button id="authenticity-clear-btn" class="clear-btn hidden">&times;</button><p class="font-semibold text-gray-700">Authenticity</p><input type="file" id="authenticity-file-input" class="hidden" accept=".txt"></div>
                            <div id="assembly_history-upload-box" class="upload-box"><button id="assembly_history-clear-btn" class="clear-btn hidden">&times;</button><p class="font-semibold text-gray-700">Assembly History</p><input type="file" id="assembly_history-file-input" class="hidden" accept=".txt"></div>
                            <div id="future_pull-upload-box" class="upload-box"><button id="future_pull-clear-btn" class="clear-btn hidden">&times;</button><p class="font-semibold text-gray-700">Future Pull</p><input type="file" id="future_pull-file-input" class="hidden" accept=".txt"></div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Synthesis & Analysis -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="card p-6">
                        <h2 class="text-xl font-bold mb-4">2. Review & Edit Your Data</h2>
                        <div id="review-grid" class="review-grid p-2 bg-gray-50 rounded-lg">
                             <!-- Text areas will be dynamically created here -->
                        </div>
                    </div>
                    <div class="card p-6">
                        <h2 class="text-xl font-bold mb-4">3. Guided Synthesis</h2>
                         <div class="mb-4 p-4 bg-gray-50 rounded-lg border">
                            <h3 class="font-semibold mb-2">AI Tutor Settings</h3>
                            <div class="flex flex-col sm:flex-row items-center gap-2">
                                <input type="password" id="api-key-input" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm" placeholder="Enter Google AI API Key">
                                <button id="save-key-btn" class="btn btn-secondary px-4 py-2 text-sm rounded-lg font-semibold">Save Key</button>
                            </div>
                            <p id="key-status" class="text-xs text-gray-500 mt-2">Need a key? <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 underline">Get one from Google AI Studio.</a></p>
                        </div>

                        <div id="chat-container" class="w-full h-96 flex flex-col border bg-white rounded-lg p-4">
                            <div id="chat-history" class="flex-1 overflow-y-auto mb-4 flex flex-col">
                                <!-- Chat messages will appear here -->
                            </div>
                            <div id="chat-input-area" class="flex items-center gap-2">
                                <textarea id="chat-input" class="w-full border border-gray-300 rounded-lg p-2 resize-none" placeholder="Type your response..." rows="2" disabled></textarea>
                                <button id="chat-send-btn" class="btn btn-primary px-6 py-2 rounded-lg font-semibold" disabled>Send</button>
                            </div>
                        </div>
                        
                        <div class="mt-6 text-right">
                            <button id="download-prf-btn" class="btn btn-primary px-8 py-3 rounded-lg font-semibold">Download Full PRF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Screen Elements ---
            const startScreen = document.getElementById('start-screen');
            const explanationScreen = document.getElementById('explanation-screen');
            const mainApp = document.getElementById('main-app');
            
            // --- Button Elements ---
            const startHereBtn = document.getElementById('start-here-btn');
            const continueToAppBtn = document.getElementById('continue-to-app-btn');
            const backToStartBtn = document.getElementById('back-to-start-btn');
            const loadDataBtn = document.getElementById('load-data-btn');

            // --- Main App Elements ---
            const reviewGrid = document.getElementById('review-grid');
            const downloadPrfBtn = document.getElementById('download-prf-btn');
            const apiKeyInput = document.getElementById('api-key-input');
            const saveKeyBtn = document.getElementById('save-key-btn');
            const keyStatus = document.getElementById('key-status');
            
            // --- Chat Elements ---
            const chatHistory = document.getElementById('chat-history');
            const chatInput = document.getElementById('chat-input');
            const chatSendBtn = document.getElementById('chat-send-btn');

            const DATA_KEYS = {
                beliefs: 'prf_beliefs_data',
                rules: 'prf_rules_data',
                ontology: 'prf_ontology_data',
                authenticity: 'prf_authenticity_data',
                assembly_history: 'prf_assembly_history_data',
                future_pull: 'prf_future_pull_data'
            };

            const CATEGORIES = Object.keys(DATA_KEYS);

            // --- Screen Navigation ---
            startHereBtn.addEventListener('click', () => { startScreen.classList.add('hidden'); explanationScreen.classList.remove('hidden'); });
            continueToAppBtn.addEventListener('click', () => { explanationScreen.classList.add('hidden'); mainApp.classList.remove('hidden'); mainApp.classList.add('screen'); });
            backToStartBtn.addEventListener('click', () => { mainApp.classList.add('hidden'); startScreen.classList.remove('hidden'); });
            
            // --- API Key Handling ---
            const API_KEY_STORAGE = 'prf_synthesizer_api_key';
            saveKeyBtn.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem(API_KEY_STORAGE, key);
                    keyStatus.textContent = 'API Key saved successfully in your browser.';
                    keyStatus.classList.add('text-green-600');
                    setTimeout(() => {
                        keyStatus.innerHTML = 'Need a key? <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-indigo-600 underline">Get one from Google AI Studio.</a>';
                        keyStatus.classList.remove('text-green-600');
                    }, 3000);
                }
            });

            function loadApiKey() {
                const savedKey = localStorage.getItem(API_KEY_STORAGE);
                if (savedKey) {
                    apiKeyInput.value = savedKey;
                }
            }
            loadApiKey();


            // --- Dynamic Creation of Review Boxes ---
            CATEGORIES.forEach(key => {
                const formattedName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                // Create container
                const container = document.createElement('div');
                container.className = 'review-box-container';
                container.dataset.key = key;

                // Create textarea
                const textarea = document.createElement('textarea');
                textarea.id = `${key}-display`;
                textarea.className = 'w-full h-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-indigo-400 focus:outline-none';
                textarea.placeholder = `${formattedName} data will appear here...`;
                container.appendChild(textarea);
                
                // Create expand/collapse button
                const expandBtn = document.createElement('button');
                expandBtn.className = 'expand-btn';
                expandBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/></svg>`;
                expandBtn.title = `Focus on ${formattedName}`;
                container.appendChild(expandBtn);

                reviewGrid.appendChild(container);

                // Focus Mode Logic
                expandBtn.addEventListener('click', () => {
                    const isFocused = container.classList.contains('is-focused');
                    // Remove focus from all containers first
                    reviewGrid.querySelectorAll('.review-box-container').forEach(c => c.classList.remove('is-focused'));
                    
                    if (isFocused) {
                        reviewGrid.classList.remove('focused');
                        expandBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/></svg>`;
                        expandBtn.title = `Focus on ${formattedName}`;

                    } else {
                        reviewGrid.classList.add('focused');
                        container.classList.add('is-focused');
                        expandBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-fullscreen-exit" viewBox="0 0 16 16"><path d="M5.5 0a.5.5 0 0 1 .5.5v4A.5.5 0 0 1 5 5h-4a.5.5 0 0 1 0-1h3.5V.5a.5.5 0 0 1 .5-.5zM5 11h4a.5.5 0 0 1 0 1H5a.5.5 0 0 1 0-1zm11-5.5a.5.5 0 0 1-1 0V1.5H11.5a.5.5 0 0 1 0-1H15a.5.5 0 0 1 .5.5v4zM11 11h3.5a.5.5 0 0 1 0 1H11a.5.5 0 0 1 0-1z"/></svg>`;
                        expandBtn.title = `Return to Grid View`;
                    }
                });
            });

            // --- Dynamic Creation of Upload Boxes and File Handling ---
            CATEGORIES.forEach(key => {
                const uploadBox = document.getElementById(`${key}-upload-box`);
                const fileInput = document.getElementById(`${key}-file-input`);
                const clearBtn = document.getElementById(`${key}-clear-btn`);
                const display = document.getElementById(`${key}-display`);

                const handleFile = (file) => {
                    if (file && file.type === 'text/plain') {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const newContent = e.target.result;
                            if (display.value.trim().length > 0) {
                                display.value += `\n\n----------\n(New File: ${file.name})\n----------\n\n` + newContent;
                            } else {
                                display.value = newContent;
                            }
                            uploadBox.classList.add('filled');
                            clearBtn.classList.remove('hidden');
                        };
                        reader.readAsText(file);
                    } else {
                        alert('Please upload a valid .txt file.');
                    }
                };

                uploadBox.addEventListener('click', (e) => { if (e.target !== clearBtn) fileInput.click(); });
                fileInput.addEventListener('change', (event) => handleFile(event.target.files[0], key));
                uploadBox.addEventListener('dragover', (event) => { event.preventDefault(); uploadBox.classList.add('drag-over'); });
                uploadBox.addEventListener('dragleave', () => uploadBox.classList.remove('drag-over'));
                uploadBox.addEventListener('drop', (event) => { event.preventDefault(); uploadBox.classList.remove('drag-over'); handleFile(event.dataTransfer.files[0], key); });
                clearBtn.addEventListener('click', () => {
                    display.value = '';
                    uploadBox.classList.remove('filled');
                    clearBtn.classList.add('hidden');
                    fileInput.value = ''; 
                });
            });
            
            // --- Load Data from LocalStorage ---
            loadDataBtn.addEventListener('click', () => {
                let loadedCount = 0;
                CATEGORIES.forEach(key => {
                    const savedData = localStorage.getItem(DATA_KEYS[key]);
                    if (savedData) {
                        const display = document.getElementById(`${key}-display`);
                        display.value = savedData;
                        document.getElementById(`${key}-upload-box`).classList.add('filled');
                        document.getElementById(`${key}-clear-btn`).classList.remove('hidden');
                        loadedCount++;
                    }
                });
                if (loadedCount > 0) {
                    alert(`${loadedCount} data source(s) loaded successfully from your browser.`);
                } else {
                    alert('No saved data found from the explorer apps in this browser.');
                }
            });


            // --- Guided Synthesis (Chat) Logic ---
            let conversationHistory = [];
            let currentStep = -1;

            const synthesisSteps = [
                {
                    type: 'start',
                    prompt: "Let's begin the guided synthesis of your Personal Reality Framework. I'll walk you through connecting your ideas. When you're ready, click 'Send' to start with your Beliefs."
                },
                {
                    type: 'module',
                    key: 'beliefs',
                    prompt: "First, let's look at your **Beliefs**. I've reviewed what you wrote. In your own words, what is the single most important belief that acts as a foundation for your framework?"
                },
                {
                    type: 'module',
                    key: 'rules',
                    prompt: "That's a clear foundation. Now let's bring in your **Rules**. How does one of your key rules connect to or stem from the core belief you just described?"
                },
                {
                    type: 'module',
                    key: 'ontology',
                    prompt: "Interesting connection. Next is your **Ontology**—your view of what is 'real'. How does your understanding of reality support the beliefs and rules we've discussed?"
                },
                {
                    type: 'module',
                    key: 'authenticity',
                    prompt: "That adds another layer. Let's consider **Authenticity**. How does living by these beliefs and rules help you feel authentic and true to yourself?"
                },
                {
                    type: 'module',
                    key: 'assembly_history',
                    prompt: "Great. Now let's connect this to your past. Looking at your **Assembly History**, can you identify a key event or experience that helped form these core parts of your framework?"
                },
                {
                    type: 'module',
                    key: 'future_pull',
                    prompt: "That provides important context. Finally, let's look to the future. How does your **Future Pull**—the person you are trying to become—guide or give purpose to the framework we have been building?"
                },
                 {
                    type: 'end',
                    prompt: "We have now connected all six parts of your framework. You've done excellent work. Based on our conversation, please write a final, one-paragraph synthesis in the box below that ties everything together. This conversation will be included when you download your PRF."
                }
            ];

            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}-message`;
                messageDiv.textContent = text;
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll
                conversationHistory.push({ role: sender, parts: [{ text }] });
            }

            async function getAiResponse() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    addMessage("I can't proceed without a valid Google AI API key. Please enter it above.", 'ai');
                    return;
                }
                
                chatInput.disabled = true;
                chatSendBtn.disabled = true;
                addMessage("Thinking...", 'ai-thinking'); // Placeholder for spinner

                const prompt = `You are a helpful philosophy tutor. You are having a conversation with a student to help them synthesize their Personal Reality Framework. Their previous response in the conversation is: "${conversationHistory[conversationHistory.length-1].parts[0].text}". Your next step in the conversation is to say: "${synthesisSteps[currentStep].prompt}". Please respond to the student by first briefly and supportively acknowledging their last response, and then asking the next question as instructed. Keep your response conversational and encouraging.`;

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: conversationHistory, generationConfig: { "stopSequences": ["User:"] } })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    const aiText = result.candidates[0].content.parts[0].text;
                    
                    document.querySelector('.ai-thinking-message')?.remove(); // Remove thinking message
                    addMessage(aiText, 'ai');

                } catch (error) {
                     document.querySelector('.ai-thinking-message')?.remove(); // Remove thinking message
                     addMessage(`An error occurred: ${error.message}. Please check your API key and network connection.`, 'ai');
                } finally {
                    if (currentStep < synthesisSteps.length) {
                        chatInput.disabled = false;
                        chatSendBtn.disabled = false;
                        chatInput.focus();
                    }
                }
            }

            function startNextStep() {
                currentStep++;
                if (currentStep < synthesisSteps.length) {
                    const step = synthesisSteps[currentStep];
                    if(step.type === 'start' || step.type === 'end') {
                         addMessage(step.prompt, 'ai');
                         if(step.type === 'end') {
                             chatInput.disabled = true;
                             chatSendBtn.disabled = true;
                             chatInput.placeholder = "Write your final synthesis in the box below.";
                         }
                    } else {
                        // For module steps, we need user input first. Let's make the prompt part of the AI's response.
                        // The logic for this is now handled within the getAiResponse function.
                        // For the very first module, we need to kick it off.
                        if (currentStep === 1) { // This is the first module step.
                            let initialPrompt = "You are a helpful philosophy tutor starting a guided synthesis. Your first task is to ask the student about their Beliefs. Please say: '" + step.prompt + "'";
                             addMessage(step.prompt, 'ai');
                        }
                    }
                }
            }
            
            chatSendBtn.addEventListener('click', () => {
                const userText = chatInput.value.trim();
                if (!userText) return;
                
                addMessage(userText, 'user');
                chatInput.value = '';

                if (currentStep === 0) { // After user clicks send on the intro message
                    startNextStep();
                    return;
                }

                if (currentStep < synthesisSteps.length -1) {
                    const nextStep = synthesisSteps[currentStep + 1];
                    let allData = `Here is all the student's data for context:\n\n`;
                    CATEGORIES.forEach(key => {
                        const formattedName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        allData += `--- ${formattedName} ---\n${document.getElementById(`${key}-display`).value || 'No data provided.'}\n\n`;
                    });

                    let promptForAi = `You are a helpful and conversational philosophy tutor. You are guiding a student through synthesizing their Personal Reality Framework. We are on step ${currentStep + 1} of ${synthesisSteps.length - 1}.
                    
                    The student has just responded to your previous question. Their response was: "${userText}"
                    
                    Your next task is to ask them about **${nextStep.key.replace(/_/g, ' ')}**. Your prompt for this is: "${nextStep.prompt}"
                    
                    Please generate a response that does two things:
                    1. Briefly and supportively acknowledge their previous answer ("${userText}").
                    2. Seamlessly transition into asking the next question as instructed.
                    
                    Keep your tone encouraging. Here is the student's full data for your reference:\n${allData}`;

                    conversationHistory.push({ role: 'user', parts: [{text: userText}]});
                    // This is a simplified approach. A more robust implementation would call the AI here.
                    // For now, we'll just present the next question.
                    currentStep++;
                    addMessage(synthesisSteps[currentStep].prompt, 'ai');
                     if(synthesisSteps[currentStep].type === 'end') {
                        chatInput.disabled = true;
                        chatSendBtn.disabled = true;
                        chatInput.placeholder = "Write your final synthesis in the box below.";
                    }

                } else {
                     // End of conversation
                }
            });


            function initializeChat() {
                // Clear existing history
                chatHistory.innerHTML = '';
                conversationHistory = [];
                currentStep = -1;

                // Check if any data is loaded
                const hasData = CATEGORIES.some(key => document.getElementById(`${key}-display`).value.trim() !== '');

                if (hasData) {
                    startNextStep(); // Start with the intro message
                    chatInput.disabled = false;
                    chatSendBtn.disabled = false;
                    chatInput.placeholder = "Type your response here...";
                } else {
                    addMessage("Please load or upload some data from your explorers before we can begin the guided synthesis.", 'ai');
                    chatInput.disabled = true;
                    chatSendBtn.disabled = true;
                    chatInput.placeholder = "Load data to begin...";
                }
            }

            // A button to start/restart the chat, maybe? For now, it starts when data is loaded.
            // Let's change this to an explicit button.
            chatHistory.innerHTML = '';
            const startChatBtn = document.createElement('button');
            startChatBtn.textContent = 'Begin Guided Synthesis';
            startChatBtn.className = 'btn btn-primary mx-auto';
            chatHistory.appendChild(startChatBtn);
            
            startChatBtn.addEventListener('click', () => {
                initializeChat();
            });


            // --- Download Full PRF ---
            downloadPrfBtn.addEventListener('click', () => {
                let fullPrfText = "My Personal Reality Framework\n============================\n\n";
                CATEGORIES.forEach(key => {
                    const formattedName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const display = document.getElementById(`${key}-display`);
                    fullPrfText += `--- ${formattedName} ---\n` + (display.value || "No data uploaded.") + "\n\n";
                });
                
                if (conversationHistory.length > 0) {
                    fullPrfText += "============================\n--- GUIDED SYNTHESIS CONVERSATION ---\n";
                    conversationHistory.forEach(msg => {
                        const sender = msg.role === 'user' ? 'Me' : 'AI Tutor';
                        fullPrfText += `\n[${sender}]:\n${msg.parts[0].text}\n`;
                    });
                     fullPrfText += "\n\n";
                }
                
                const finalSynthesis = document.getElementById('synthesis-input'); // Assuming you add a final synthesis box
                if(finalSynthesis && finalSynthesis.value) {
                    fullPrfText += "============================\n--- MY FINAL SYNTHESIS ---\n" + finalSynthesis.value + "\n\n";
                }


                const blob = new Blob([fullPrfText], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'My-Personal-Reality-Framework.txt';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
</body>
</html>

